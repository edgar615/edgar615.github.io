---
layout: post
title: 认证（5）-认证服务
description: 
date: 2019-03-05
categories:
    - 设计
comments: true
permalink: authentication-service.html
---

当 Token 无状态之后，单点登录就变得容易了。前端拿到一个有效的 Token，它就可以在任何同一体系的服务上认证通过——只要它们使用同样的密钥和算法来认证 Token 的有效性。就样这样：

![](/assets/images/posts/token/authentication-1.png)

 当然，如果 Token 过期了，前端仍然需要去认证服务更新 Token：
 
![](/assets/images/posts/token/authentication-2.png)

可见，虽然认证和业务分离了，实际即并没产生多大的差异。
当然，这是建立在**认证服务器信任业务服务器**的前提下，因为认证服务器产生 Token 的密钥和业务服务器认证 Token 的密钥和算法相同。换句话说，业务服务器同样可以创建有效的 Token。

如果业务服务器不能被信任，该怎么办？

遇到不受信的业务服务器时，很容易想到的办法是使用不同的密钥。认证服务器使用密钥1签发，业务服务器使用密钥2验证——这是典型非对称加密签名的应用场景。

- 认证服务器自己使用私钥对 Token 签名，公开公钥。
- 信任这个认证服务器的业务服务器保存公钥，用于验证签名。

JWT 不仅可以使用 HMAC 签名，也可以使用 RSA（一种非对称加密算法）签名。

不过，当业务服务器已经不受信任的时候，多个业务服务器之间使用相同的 Token 对用户来说是不安全的。因为任何一个服务器拿到 Token 都可以仿冒用户去另一个服务器处理业务……悲剧随时可能发生。

为了防止这种情况发生，就需要在认证服务器产生 Token 的时候，把使用该 Token 的业务服务器的信息记录在 Token 中，这样当另一个业务服务器拿到这个 Token 的时候，发现它并不是自己应该验证的 Token，就可以直接拒绝。

# 参考资料

https://juejin.im/post/6844903556424826894
