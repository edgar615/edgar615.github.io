---
layout: post
title: GRPC的SSL使用
date: 2020-06-20
categories:
    - rpc
comments: true
permalink: grpc-ssl.html
---

公司的GRPC需要加入TLS支持，记录一下学习过程。

证书的生成参考这篇文章

> https://edgar615.github.io/openssl.html

客户端：

```java

private static SslContext buildSslContext(String trustCertCollectionFilePath,
                                          String clientCertChainFilePath,
                                          String clientPrivateKeyFilePath) throws SSLException {
    SslContextBuilder builder = GrpcSslContexts.forClient();
    if (trustCertCollectionFilePath != null) {
        builder.trustManager(new File(trustCertCollectionFilePath));
    }
    if (clientCertChainFilePath != null && clientPrivateKeyFilePath != null) {
        builder.keyManager(new File(clientCertChainFilePath), new File(clientPrivateKeyFilePath));
    }
    return builder.build();
}

NettyChannelBuilder.forAddress(host, port)
                .sslContext(sslContext)
                .build()
```

服务端

```java
private SslContextBuilder getSslContextBuilder() {
    SslContextBuilder sslClientContextBuilder = SslContextBuilder.forServer(new File(certChainFilePath),
            new File(privateKeyFilePath));
    if (trustCertCollectionFilePath != null) {
        sslClientContextBuilder.trustManager(new File(trustCertCollectionFilePath));
        sslClientContextBuilder.clientAuth(ClientAuth.REQUIRE);
    }
    return GrpcSslContexts.configure(sslClientContextBuilder);
}

server = NettyServerBuilder.forPort(port)
        .addService(new GreeterImpl())
        .sslContext(getSslContextBuilder().build())
        .build()
        .start();
```
