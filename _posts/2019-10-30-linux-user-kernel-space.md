---
layout: post
title: Linux用户空间和内核空间
date: 2019-10-30
categories:
    - linux
comments: true
permalink: linux-user-kernel-space.html
---

以前在学习kafka的时候了解一个零拷贝的知识，里面说了用户空间、内核空间。一直没去看到底是怎么。这次抽时间学习了一下

Linux将运行空间划分为两个，用户空间（User space）和内核空间。

- User space：用户空间，用户程序的运行空间
- Kernel space：内核空间， Linux 内核的运行空间

不同的空间，拥有自己的内存地址范围，在32位操作系统中，一般将最高的1G字节划分为内核空间，供内核使用，而将较低的3G字节划分为用户空间，供各个进程使用。
![](/assets/images/posts/linux-user-kernel-space/linux-user-kernel-space-1.png)

其中：

- 内核空间中存放的是内核代码和数据，而进程的用户空间中存放的是用户程序的代码和数据。
- 进程在运行的时候，在内核空间和用户空间各有一个堆栈。
- 用户空间中，每个进程的用户空间是互相独立的，互不相干。
- 内核空间中，绝大部分是共享的，并不是完全共享，因为内核空间中，不同进程的内核栈之间是不共享的。
- 用户空间不能直接调用系统资源，内核空间和用户空间一般通过系统调用进行通信。 

# 内核态，用户态

当一个进程执行系统调用而陷入内核代码中执行时，称进行处于内核运行态（内核态）。此时处理器处于特权级别最高的（0级）内核代码中执行。当进程处于内核态时，执行的内核代码会使用当前进程的内核栈。每个进程都有自己的内核栈。

当进行在执行用户自己的代码时，则称其处于用户运行态（用户态）。此时处理器在特权级最低的（3级）用户代码中运行。当正在执行用户程序而突然被中断程序中断时，此时用户程序也可象征性的称为处于进行的内核态，因为中断处理程序使用当前进程的内核栈。

用户态的进程是不能访问内核所占用的内存空间，也不能直接调用内核函数的 ，因此要进行系统调用的时候，就要将进程切换到内核态中去。

例如服务端读取一个文件内容，然后发送给用户，大致的过程日下：
![](/assets/images/posts/linux-user-kernel-space/linux-user-kernel-space-2.png)

数据从I/O设备中读取之后，会先存放在内核buf中，系统调用完成之后，会将数据从内核buf拷贝到用户空间的buf，这一段就是零拷贝需要处理的逻辑

# 参考资料

http://www.ruanyifeng.com/blog/2016/12/user_space_vs_kernel_space.html

https://blog4jimmy.com/2018/01/348.html

https://cllc.fun/2019/03/02/linux-user-kernel-space/