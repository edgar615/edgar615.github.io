---
layout: post
title: MySQL索引-文件存储结构（part1）
date: 2019-05-31
categories:
    - MySQL
comments: true
permalink: mysql-index-file-storage.html
---

# 文件存储结构
![](/assets/images/posts/mysql-index/mysql-index-1.jpg)

## 表空间
表空间是Innodb存储引擎逻辑的最高层，所有的数据都存放在表空间中，默认情况下，Innodb存储引擎有一个共享表空间ibdata1,即所有数据都存放在这个表空间中内。如果启用了`innodb_file_per_table`参数，则每张表内的数据可以单独放到一个表空间内。

**但请注意，只有数据、索引、和插入缓冲Bitmap放入单独表内，其他数据，比如回滚(undo)信息、插入缓冲检索页、系统事物信息，二次写缓冲等还是放在原来的共享表内的。**
## 段
表空间由段组成，常见的段有数据段、索引段、回滚段等。因为InnoDB存储引擎表是索引组织的，因此数据即索引，索引即数据。数据段即为B+树的叶子结点，索引段即为B+树的非叶子结点。
## 区
区是由连续页组成的空间，在任何情况下每个区的大小都为1MB。为了保证区中页的连续性，InnoDB存储引擎一次从磁盘申请4~5个区。默认情况下，InnoDB存储引擎页的大小为16KB，一个区中一共64个连续的区。

**在每个段开始时，先有32个页大小的碎片页（fragment page）来存放数据，当这些页使用完之后才是64个连续页的申请。这样可以避免小表浪费空间**
## 页
页是InnoDB磁盘管理的最小单位。在InnoDB存储引擎中，默认每个页的大小为16KB。可以通过参数`innodb_page_size`将页的大小设置为4K，8K，16K。若设置完成，则所有表中页的大小都固定，不可以对其再次修改。除非通过mysqldump导入和导出操作来产生新的库。

InnoDB存储引擎中，常见的页类型有：数据页，undo页，系统页，事务数据页，插入缓冲位图页，插入缓冲空闲列表页等。
## 行
InnoDB存储引擎是面向列的，数据按行存放，每页中最多存放16KB/2-200行数据

##  总结一下
- 一个表的数据页是通过链表连在一起的
- 数据是以行为单位一行一行的存放在磁盘上的块中
- 在访问数据时，一次从磁盘中读出或者写入至少一个完整的页

# 数据基本操操作

数据的基本操作包括：INSERT、UPDATE、DELETE、SELECT

**SELECT**

1. 定位数据
2. 读出数据所在的块，对数据加工
3. 返回数据给用户

**UPDATE、DELETE**

1. 定位数据
2. 读出数据所在的块，修改数据
3. 写回磁盘

**INSERT**

1. 定位数据要插入的页（如果数据需要排序）
2. 读出要插入的数据页，插入数据.
3. 写回磁盘

可以看到数据的基本操作都需要定位数据，那么我们改如何定位数据呢？

> 表扫描遍历：从磁盘中依次读出所有的数据块，一行一行的进行数据匹配,直到找到要匹配的数据。

可以看到上述定位数据的方式的时间复杂度是O(n)， 如果所有的数据占用了100个块。尽管只查询一行数据，也需要读出所有100个块的数据。这就需要大量的磁盘IO操作，极大的影响了性能

### 局部性原理与磁盘预读

由于存储介质的特性，磁盘本身存取就比主存慢很多，再加上机械运动耗费，磁盘的存取速度往往是主存的几百分分之一，因此为了提高效率，要尽量减少磁盘I/O。为了达到这个目的，磁盘往往不是严格按需读取，而是每次都会预读，即使只需要一个字节，磁盘也会从这个位置开始，顺序向后读取一定长度的数据放入内存。这样做的理论依据是计算机科学中著名的局部性原理：

当一个数据被用到时，其附近的数据也通常会马上被使用。

程序运行期间所需要的数据通常比较集中。

由于磁盘顺序读取的效率很高（不需要寻道时间，只需很少的旋转时间），因此对于具有局部性的程序来说，预读可以提高I/O效率。

预读的长度一般为页（page）的整倍数。页是计算机管理存储器的逻辑块，硬件及操作系统往往将主存和磁盘存储区分割为连续的大小相等的块，每个存储块称为一页（在许多操作系统中，页得大小通常为4k），主存和磁盘以页为单位交换数据。当程序要读取的数据不在主存中时，会触发一个缺页异常，此时系统会向磁盘发出读盘信号，磁盘会找到数据的起始位置并向后连续读取一页或几页载入内存中，然后异常返回，程序继续运行。


# 参考资料

《MySQL技术内幕 InnoDB存储引擎第二版》

http://blog.codinglabs.org/articles/theory-of-mysql-index.html

https://mp.weixin.qq.com/s/R1zhVWNFtrpCSzM6fPmbBg

https://mp.weixin.qq.com/s/aH87AiBmwCtSf6z9JBc4uQ