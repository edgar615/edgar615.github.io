---
layout: post
title: 团队管理（9）- Code Review
date: 2021-03-08
categories:
    - 管理
comments: true
permalink: team-code-review.html
---

# 1. Code Review的好处

## 1.1. 互相学习，彼此成就

无论是高手云集的架构师团队，还是以CURD为主的业务开发团队，大家的技术能力、经验都是有差异的。

通过Code Review，对于同样的功能实现，有经验的工程师可以给经验尚浅的工程师提供合理的优化建议。经验尚浅的工程师可以通过阅读优质代码，快速学习相关技术运用的最佳实践。如果大家技术实力相当，可能就是互相刷新思想了。

> 你有一个苹果，我有一个苹果，彼此交换一下，我们仍然是各有一个苹果；但你有一种思想，我有一种思想，彼此交换，我们就都有了两种思想，甚至更多。

## 1.2. 知识共享，自动互备

在大部分团队，尤其是采用服务化架构以及微服务架构的团队，通常都是1个开发人员负责多个服务/项目（Project），如果没有Code Review，那么项目中所涉及的架构知识，或者业务知识，就只存在于项目执行过程中产出的架构文档，以及核心流程、功能的说明文档了。

文档可以帮助其他工程师了解服务/项目的情况，但通常其他工程师不会主动去阅读这些文档，等到真的要维护别的工程师写的代码，文档的完整性往往没有最初的效果好了，文档跟代码实现的匹配度也会下降。

Code Review的过程，就是根据提交者的描述阅读代码的逻辑，看代码实现是否跟描述一致。在这个时候，Reviewer就必须阅读文档，知识的传播性就更好，也基本上不会出现只有1个人了解某个项目的情况了。

## 1.3. 统一风格，提升质量

如果要给代码质量分一下等级的话，那应该是：
可以编译通过->可以正常运行->可以测试通过->容易阅读->容易维护。那么，通过Code Review的代码最起码可以达到易阅读这个级别。

要做到易阅读，可不是说只要有Code  Review这个环节就可以了，还要有相关的规范，让大家按照同样的工程风格、编码风格去构建项目和编写代码。统一风格一方面是让大家无论是维护项目还是阅读代码，不用互相适应各自的编码习惯，另外也是给Reviewer一个Code Review的基本依据。

> 发现Bug不是Code Review的必需品，而是附属品。至于那些低级的问题/bug交给代码扫描工具就可以了，这不是Code Review的职责。

# 2. 如何Code Review

## 2.1. 制定规范

规范中建议包含：

- 工程规范（工程结构，分层方式及命名等等）
- 命名规范（接口、类、方法名、变量名等）
- 代码格式（括号、空格、换行、缩进等）
- 注释规范（规定必要的注释）
- 日志规范（合理的记录必要的日志）
- 各种推荐与不推荐的代码示例

如果团队人数较少，项目的工程复杂度较低，可以自行制定规范。毕竟适合团队的就是最好的。
如果团队有一定规模，且还会不断扩张，还是建议根据大厂的规范进行制定，或者是直接采用。

> Java开发手册：https://github.com/alibaba/p3c
> Google代码风格指南：https://zh-google-styleguide.readthedocs.io （涵盖：C++、Python等）

## 2.2. 准备checklist

例如

- 这些代码更改是否符合业务需求？
- 这些代码更改是否符合团队的编码质量要求？
- 这些代码更改是否有相关的测试？
- 这些代码更改是否有截图或用户界面更改？
- 是否为这些代码更改更新了变更日志？
- 是否为这些代码更改更新了应用文档？

## 2.3. 制定流程

**确定Code Review实施环节**

CodeReview建议是放在代码提交测试前，也就是开发人员完成代码开发及自测后将代码提交到测试分支时进行Code  Review。毕竟，如果测试通过后再进行Code  Review，如果需要代码变更，势必会增加测试的工作量，甚至影响项目进度。亦或是顶着项目上线的压力，干脆“以后再说”了

以通用的Git Workflow来说，那就是把Code Review放在Feature分支合并到Develop分支时了。

**制定角色行为规范**

| 角色      | 规则                                                         |
| --------- | ------------------------------------------------------------ |
| Developer | 1、一次提交的功能必须是完整的 2、默认细粒度提交（以独立的方法/功能/模块为单位）。如需粗粒度提交，需提前跟Reviewer沟通确认 3、Commit Message中要清晰描述变更的主题 必要时，可以以链接或者文件的形式附上需求文档/设计文档 |
| Reviewer  | 1、不允许自我Review并Merge代码 2、Review不通过打回前需跟Developer说明原因并达成一致 3、Review不通过需明确填写打回的原因 4、单次Review时长需控制在2分钟~2小时内完成（特殊情况请说明原因） |
| Approver  | 1、审批不通过需注明原因 2、审批时长需要控制在1小时以内 3、对于放行的非质量问题，需持续跟进 |

这样规范，主要是为了：

1. 控制提交Code Review的代码的粒度
2. 控制单次Code Review的时间
3. 提升Commit/MergeRequest描述的质量，减少沟通成本

这样，我们就可以通过细粒度高频次的方式尽可能利用工程师碎片化的时间进行Code Review，一定程度上保证Code Review的效率。

**毕竟，粗粒度甚至是集中式的Code Review，时间上难以把控。发现了问题的时候，修复的成本也往往更高。**

## 2.4. 分享与统计

有了工具、开发规范、流程规范，就可以指引参与的工程师参与Code Review，那么我们也要对Code Review的过程以及结果进行检验，毕竟不进行检查/验收的规则，是无法达到预期效果的。

Code Review毕竟不是数学题，我们无法通过简单的计算去验证。所以我们要通过侧面验证，来帮助Code Review的执行

**定期分享**

我们是期望CodeReview可以让工程师之间互相学习的，那么对于一次Code  Review通常只有参与的2-3个工程师有互相学习的机会，那么在这个过程中学到的知识，定期的分享出来，既可以加强知识的流动，又可以检查大家究竟有没有在Code Review过程中学习到知识，或者有没有认真的进行Code Review

至于分享的内容，可以是开发规范中的范例代码，也可以是规范中的正例代码，也可以是针对某个功能实现的最佳算法/最佳实践，也可以是Code Review过程中的争议代码，也可以是自己踩过的坑。

总之，Code Review之后的代码分享，不但可以加强知识的流动，还可以检验Code Review的效果。

**数据统计**

为了在一定程度上保证Code Review的效率，我们在规范里是要求参与的工程师：

1. Developer控制提交Code Review的粒度，或者控制每个Commit的粒度
2. Developer要准确清晰的描述所提交的代码
3. Reviewer&Approver要在规定时间内完成Code Review

这些情况纯粹靠人工是无法检验的，还是需要有一定的数据统计。
如果用Gerrit，可以查询Gerrit的数据库，里面会有Code Review的信息，
如果用GitLab，可以通过WebHook或者restful API获取Code Review信息

我们可以做成报表，来展示Code Review的情况：

1. 每人每周Code Review所消耗的时间
2. 每人每周被Code Review所消耗的平均时间
3. 超过规定时间的Code Review情况
4. 代码提交描述字数过少的情况
5. 等等（根据自己的需要来）

以上情况只是Code Review的侧面反馈，用来帮我们发现Code Review执行过程中可能出现的问题。不过，出现问题并不意味着Code Review的质量/效率一定受到了影响。

比如，工程师A被Code  Review的耗时是团队内最高，有可能是有某次代码是周五晚上提交的CodeReviw，这单次CodeReview的耗时就会超过48小时。也有可能是对应的Reviewer是团队新人，要通过相关业务项目了解对应Project的承担的职责及代码，这是个学习的过程，自然耗时加长。

又比如工程师B提交的代码描述文字过少，可能就是中间件团队对某些基础组件进行升级，或者安全团队要求升级某个依赖的开源组件，以修复某个安全漏洞。

但是通过这种的数据，可以让Code Review的情况直观的展示出来。来发现大家执行过程中需要优化的事项， 不断帮助大家完善规则，做好执行。

## 2.5. 保证Code Review质量的关键

**工程师对研发规范的认真学习**

无论Code Review的工具以及流程是怎么样的，都少不了开发规范作为支撑，毕竟我们期望Code Review达到的效果之一就是，团队中的工程师可以写出像规范中描述那样的高质量代码。

工程师对研发规范的掌握程度，决定了自己编码代码的质量，也决定了自己Review通过的代码的质量。所以，无论如何，加强对研发规范的学习和理解，都是保证Code Review质量的重中之重

**资深工程师的认真对待**

Code Review目的是帮助工程师交流和学习进步的。无论是技术能力还是编码习惯，亦或是业务知识。无论规则怎么制定，终究还是需要参与的工程师来执行，如果大家互相睁一只眼闭一只眼，互相降低要求，那么执行的效果一定会打折扣。

虽说三人行必有我师，但收益最大的一定是经验(技能/业务知识)尚浅的工程师，收益最低的一定是团队中最资深的工程师。而恰恰经验尚浅的工程师的收益大部分都要来自资深工程师的付出。

所以，一定要跟资深工程师最好沟通，让他们严格要求，不能对经验尚浅的工程师放水，以帮助他们提升编码能力以及业务知识。

这也可以减少甚至避免他们为经验尚浅的工程师的代码“善后”。

# 3. 对团队成员要求

前面已经提到，要增强团队成员对CR环节的认同感。作为CR环节的参与者，还应该根据自己的团队特点，对团队成员做出相应要求，可以参考我们团队。

## 3.1. Reviewer

1. 指明review的级别。reviewer再给相应的代码添加评论时，建议指明评论的级别，可以在评论前用[]作出标识，例如：

    - [request]xxxxxxx　　　　　　　此条评论的代码必须修改才能予以通过
    - [advise]xxxxxxxx　　　　　　　此条评论的代码建议修改，但不修改也可以通过
    - [question]xxxxxx　　　　　　　此条评论的代码有疑问，需reviewee进一步解释

2. 讲明该评论的原因。在对代码做出评论时，应当解释清楚原因，如果自己有现成的更好地解决思路，应该把相应的解决思路也评论上，节省reviewee的修改时间。
3. 平等友善的评论。评论者在review的过程中，目的是提升项目代码质量，而不是抨击别人，质疑别人的能力，应该保持平等友善的语气。
4. 享受Code Review。只有积极的参与CR，把CR作为一种享受，才能将CR的价值最大化的体现。

## 3.2. Reviewee

1. 注重注释。对于复杂代码写明相应注释，在进行commit时也应简明的写清楚背景，帮助reviewer理解，提高review的效率。
2. 保持乐观的心态接受别人的review。团队成员的review不是对你的批判，而是帮助你的提升，所以要尊重别人的review，如果review你感觉不正确，可以在下面提出疑问，进一步解释。
3. 完成相应review的修改应当在下面及时进行回复，保持信息同步。

# 4. 参考资料

https://ken.io/note/how-to-do-code-review-in-a-team