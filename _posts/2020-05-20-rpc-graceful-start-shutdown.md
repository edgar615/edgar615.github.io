---
layout: post
title: RPC优雅的启动和关闭
date: 2020-05-20
categories:
    - rpc
comments: true
permalink: rpc-graceful-start-shutdown.md.html
---

# 1. 优雅的关闭

当服务提供方要上线的时候，一般是通过部署系统完成实例重启。在这个过程中，服务提供方的团队并不会事先告诉调用方他们需要操作哪些机器，从而让调用方去事先切走流量。
而对调用方来说，它也无法预测到服务提供方要对哪些机器重启上线，因此负载均衡就有可能把要正在重启的机器选出来，这样就会导致把请求发送到正在重启中的机器里面，从而导致调用方不能拿到正确的响应结果。

在服务重启的时候，对于调用方来说，这时候可能会存在以下几种情况：

- 调用方发请求前，目标服务已经下线。对于调用方来说，跟目标节点的连接会断开，这时候调用方可以立马感知到，并且在其健康列表里面会把这个节点挪掉，自然也就不会被负载均衡选中。
- 调用方发请求的时候，目标服务正在关闭，但调用方并不知道它正在关闭，而且两者之间的连接也没断开，所以这个节点还会存在健康列表里面，因此该节点就有一定概率会被负载均衡选中。

为了避免关闭导致调用方业务受损。我们可以在重启服务机器前，先通过“某种方式”把要下线的机器从调用方维护的“健康列表”里面删除就可以了。

因为服务端都注册到了注册中心，我们可以考虑通过注册中心告诉调用方进行节点摘除。当服务提供方关闭前，是不是可以先通知注册中心进行下线，然后通过注册中心告诉调用方进行节点摘除。整个关闭过程中依赖了两次 RPC 调用:

- 服务提供方通知注册中心下线操作
- 注册中心通知服务调用方下线节点操作

但是我们知道，服务发现只保证最终一致性，并不保证实时性，注册中心在收到服务提供方下线的时候，并不能成功保证把这次要下线的节点推送到所有的调用方。所以通过服务发现并不能做到应用无损关闭。

因为服务提供方已经开始进入关闭流程，那么很多对象就可能已经被销毁了，关闭后再收到的请求按照正常业务请求来处理，肯定是没法保证能处理的。所以我们可以在关闭的时候，设置一个请求“挡板”挡板的作用就是告诉调用方，我已经开始进入关闭流程了，我不能再处理你这个请求了。

然后调用方收到对应的异常响应后，RPC 框架把这个节点从健康列表挪出，并把请求自动重试到其他节点，因为这个请求是没有被服务提供方处理过，所以可以安全地重试到其他节点，这样就可以实现对业务无损。

但如果只是靠等待被动调用，就会让这个关闭过程整体有点漫长。因为有的调用方那个时刻没有业务请求，就不能及时地通知调用方了，所以我们可以加上主动通知流程，这样既可以保证实时性，也可以避免通知失败的情况。

如果进程结束过快会造成正在处理的请求还没有来得及应答，同时调用方会也会抛出异常。为了尽可能地完成正在处理的请求，服务方在关闭过程中，在拒绝新请求的同时，需要根据引用计数器等待正在处理的请求全部结束之后才会真正关闭。

但考虑到有些业务请求可能处理时间长，或者存在被挂住的情况，为了避免一直等待造成应用无法正常退出，我们可以在整个 ShutdownHook 里面，加上超时时间控制，当超过了指定时间没有结束，则强制退出应用。

